<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TextplainToJpegRenderer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-content-renditions</a> &gt; <a href="index.source.html" class="el_package">org.springframework.content.renditions.renderers</a> &gt; <span class="el_source">TextplainToJpegRenderer.java</span></div><h1>TextplainToJpegRenderer.java</h1><pre class="source lang-java linenums">package org.springframework.content.renditions.renderers;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.content.commons.renditions.RenditionProvider;
import org.springframework.content.renditions.RenditionException;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;

import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.font.FontRenderContext;
import java.awt.font.LineBreakMeasurer;
import java.awt.font.TextAttribute;
import java.awt.font.TextLayout;
import java.awt.geom.Rectangle2D;
import java.awt.image.BufferedImage;
import java.io.*;
import java.text.AttributedCharacterIterator;
import java.text.AttributedString;
import java.util.ArrayList;

@Service
public class TextplainToJpegRenderer implements RenditionProvider {

<span class="fc" id="L26">    private static Log logger = LogFactory.getLog(WordToJpegRenderer.class);</span>

<span class="fc" id="L28">    private static int width = 272;</span>
<span class="fc" id="L29">    private static int margin = 5;</span>
<span class="fc" id="L30">    private static String fontName = &quot;Courier New&quot;;</span>
<span class="fc" id="L31">    private static int fontSize = 12;</span>

<span class="pc" id="L33">    private boolean wrapText = false;</span>

<span class="nc" id="L35">    public TextplainToJpegRenderer() {}</span>

<span class="fc" id="L37">    public TextplainToJpegRenderer(boolean wrapText) {</span>
<span class="fc" id="L38">        this.wrapText = wrapText;</span>
<span class="fc" id="L39">    }</span>

    @Override
    public String consumes() {
<span class="fc" id="L43">        return &quot;text/plain&quot;;</span>
    }

    @Override
    public String[] produces() {
<span class="fc" id="L48">        return new String[] {&quot;image/jpg&quot;, &quot;image/jpeg&quot;};</span>
    }

    @Override
    public InputStream convert(InputStream fromInputSource, String toMimeType) {

<span class="fc" id="L54">        Assert.notNull(fromInputSource, &quot;input source must not be null&quot;);</span>

<span class="fc" id="L56">        Font font = null;</span>
        try {
<span class="fc" id="L58">            font = new Font(fontName, Font.PLAIN, (int) fontSize);</span>
<span class="nc" id="L59">        } catch (Exception e) {</span>
<span class="nc" id="L60">            throw new RenditionException(&quot;Error creating font&quot;, e);</span>
<span class="fc" id="L61">        }</span>

<span class="fc" id="L63">        BufferedImage tempBuffer = new BufferedImage(1, 1, BufferedImage.TYPE_INT_RGB);</span>
<span class="fc" id="L64">        Graphics2D g = tempBuffer.createGraphics();</span>
<span class="fc" id="L65">        g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span>
<span class="fc" id="L66">        g.setFont(font);</span>

<span class="fc" id="L68">        FontRenderContext fc = g.getFontRenderContext();</span>
<span class="fc" id="L69">        Rectangle2D bounds = font.getStringBounds(&quot;Random Text&quot;, fc);</span>
<span class="fc" id="L70">        int lineHeight = (int)bounds.getHeight();</span>

<span class="fc" id="L72">        BufferedReader reader = null;</span>

        try {
<span class="fc" id="L75">            reader = new BufferedReader(new InputStreamReader(fromInputSource));</span>
<span class="nc" id="L76">        } catch (Exception e) {</span>
<span class="nc" id="L77">            throw new RenditionException(&quot;Error opening input stream&quot;, e);</span>
<span class="fc" id="L78">        }</span>

<span class="fc" id="L80">        ArrayList images = new ArrayList();</span>

<span class="fc" id="L82">        int lineCnt = margin + margin;</span>

        while (true) {
            String line;

            try {
<span class="fc" id="L88">                line = reader.readLine();</span>
<span class="nc" id="L89">            } catch (IOException ignore) {</span>
<span class="nc" id="L90">                break;</span>
<span class="fc" id="L91">            }</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">            if (line == null) { // EOF</span>
<span class="fc" id="L94">                break;</span>
            }

<span class="fc bfc" id="L97" title="All 2 branches covered.">            if (&quot;&quot;.equals(line)) { // Empty line</span>
<span class="fc" id="L98">                line = &quot; &quot;;</span>
            }

<span class="fc" id="L101">            AttributedString attribString = new AttributedString(line);</span>
<span class="fc" id="L102">            attribString.addAttribute(TextAttribute.BACKGROUND, Color.WHITE, 0, line.length());</span>
<span class="fc" id="L103">            attribString.addAttribute(TextAttribute.FOREGROUND, Color.BLACK, 0, line.length());</span>
<span class="fc" id="L104">            attribString.addAttribute(TextAttribute.FONT, font, 0, line.length());</span>

<span class="fc" id="L106">            AttributedCharacterIterator aci = attribString.getIterator();</span>
<span class="fc" id="L107">            LineBreakMeasurer lbm = new LineBreakMeasurer(aci, fc);</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">            while (lbm.getPosition() &lt; line.length()) {</span>
<span class="fc" id="L110">                BufferedImage lineBuffer = new BufferedImage(width, lineHeight, BufferedImage.TYPE_INT_ARGB);</span>

<span class="fc" id="L112">                Graphics2D g1 = lineBuffer.createGraphics();</span>
<span class="fc" id="L113">                g1.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span>

<span class="fc" id="L115">                TextLayout layout = lbm.nextLayout(width - margin);</span>

<span class="fc" id="L117">                int y = (int) layout.getAscent();</span>

<span class="fc" id="L119">                layout.draw(g1, margin, y);</span>
<span class="fc" id="L120">                images.add(lineBuffer);</span>
<span class="fc" id="L121">                lineCnt += lineHeight;</span>

<span class="fc bfc" id="L123" title="All 4 branches covered.">                if (lineCnt + lineHeight &gt; 480 || !wrapText) {</span>
<span class="fc" id="L124">                    break;</span>
                }
<span class="fc" id="L126">            }</span>
<span class="fc" id="L127">        }</span>

<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (lineCnt != 0) {</span>
            try {
<span class="fc" id="L131">                saveImage(images, lineHeight, &quot;/tmp/textToJpeg.jpeg&quot;);</span>
<span class="fc" id="L132">                return new FileInputStream(&quot;/tmp/textToJpeg.jpeg&quot;);</span>
<span class="nc" id="L133">            } catch (IOException e) {</span>
<span class="nc" id="L134">                throw new RenditionException(&quot;Error writing image&quot;, e);</span>
            }
        }

<span class="nc" id="L138">        return null;</span>
    }

    private void saveImage(ArrayList&lt;BufferedImage&gt; images, int lineHeight, String fileName) throws IOException {
<span class="fc" id="L142">        BufferedImage buffer = new BufferedImage(272, 480, BufferedImage.TYPE_INT_RGB);</span>

<span class="fc" id="L144">        Graphics2D g = buffer.createGraphics();</span>
<span class="fc" id="L145">        g.setBackground(Color.WHITE);</span>
<span class="fc" id="L146">        g.clearRect(0, 0, 272, 480);</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">        for (int i = 0; i &lt; images.size(); i++) {</span>
<span class="fc" id="L149">            g.drawImage((BufferedImage) images.get(i), 0, margin + (i * lineHeight), null);</span>
        }

<span class="fc" id="L152">        OutputStream out = new FileOutputStream(new File(fileName.toString()));</span>
<span class="fc" id="L153">        ImageIO.write(buffer, &quot;jpg&quot;, out);</span>
<span class="fc" id="L154">        out.close();</span>
<span class="fc" id="L155">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>